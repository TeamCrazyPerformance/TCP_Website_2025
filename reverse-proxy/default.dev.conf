# ======================= 개발(dev) vs 배포(prod) 차이 =======================
# 이 파일은 개발환경 전용 reverse-proxy 설정입니다.
#
# 1) 프로토콜
#   - dev: HTTP(80)만 사용, 인증서 없음
#   - prod: HTTPS(443) 사용, 80 -> 443 강제 리다이렉트
#
# 2) 보안 헤더
#   - dev: 최소한의 헤더만 설정 (개발 편의)
#   - prod: HSTS, 보안 헤더, 프록시 보안 옵션 강화 **(예정)**
#
# 3) 서비스 접근 방식
#   - dev: 내부 서비스(api, web)에 직접 프록시
#   - prod: 동일하되, TLS 종료 지점이 reverse-proxy이며 접근 제어 강화
#
# 4) 용도
#   - dev: 로컬 개발 / 팀 내부 테스트
#   - prod: 실제 사용자 트래픽 처리
# ========================================================================

# ======================= 업스트림 설정 =======================
# 내부 컨테이너 네트워크에서 서비스 이름으로 라우팅
# (docker-compose 서비스명과 동일해야 함)

upstream api {
    server api:3000;   # dev: API 서버 (Node, FastAPI 등)
}

upstream web {
    server web:80;     # dev: 프론트엔드 정적 서버 또는 dev 서버
}

# ======================= HTTP 서버 (개발용) =======================
# dev: HTTPS 없이 80 포트만 사용
# prod: 이 블록 대신 80 -> 443 리다이렉트 + 443 SSL 서버 블록을 사용

server {
    listen 80 default_server;
    server_name _;

    # ---------- API 라우팅 ----------
    # /api/ 로 들어오는 요청은 api 컨테이너로 전달
    location /api/ {
        proxy_pass http://api;

        # 클라이언트 정보 전달 (dev에서도 디버깅용으로 유지)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # dev: HTTP 환경이므로 X-Forwarded-Proto 를 http 로 고정
        # prod: https 로 설정되며, SSL termination 이후 전달됨
        proxy_set_header X-Forwarded-Proto http;
    }

    # ---------- Web(프론트엔드) 라우팅 ----------
    # 나머지 모든 요청은 web 컨테이너로 전달
    location / {
        proxy_pass http://web;
        proxy_set_header Host $host;
    }
}
