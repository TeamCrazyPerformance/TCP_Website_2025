# 5. 개발 및 배포 가이드

> [← 메인 문서로 돌아가기](./README.md)

---

## 로컬 개발 환경 설정

### 1. 사전 요구사항

```bash
# Node.js 18+ 및 npm 설치
node -v  # 18.x 이상이어야 함
npm -v

# Docker 및 Docker Compose 설치
docker -v
docker-compose -v
```

### 2. 환경 설정

`envs/` 디렉토리에 환경 파일 생성:

**`envs/api.env`**:
```env
JWT_SECRET=your-secret-key-change-this
BCRYPT_SALT_ROUNDS=12
PORT=3000
NODE_ENV=development
FRONTEND_URL=http://localhost:3001
```

**`envs/db_dev.env`**:
```env
POSTGRES_USER=devuser
POSTGRES_PASSWORD=devpassword
POSTGRES_DB=tcp_db
DB_HOST=localhost
DB_PORT=5432
DB_USER=devuser
DB_PASSWORD=devpassword
DB_NAME=tcp_db
ADMIN_EMAIL=admin@tcp.com
ADMIN_PASSWORD=admin1234!
ADMIN_USERNAME=admin
```

### 3. 데이터베이스 시작 (Docker)

```bash
# 개발용 PostgreSQL만 시작
docker-compose -f docker-compose.dev.yml up -d db
```

### 4. 백엔드 개발

```bash
cd api

# 의존성 설치
npm install

# 데이터베이스 시딩 (관리자 사용자 생성)
npm run seed

# 개발 서버 시작
npm run start:dev
```

백엔드 실행 주소: http://localhost:3000

### 5. 프론트엔드 개발

```bash
cd web

# 의존성 설치
npm install

# 개발 서버 시작
npm start
```

프론트엔드 실행 주소: http://localhost:3001

---

## 개발 명령어

### 백엔드 (API)

```bash
npm run start:dev      # 워치 모드
npm run build          # 프로덕션용 빌드
npm run lint           # 코드 린트
npm run format         # Prettier로 코드 포맷
npm run test           # 유닛 테스트 실행
npm run test:e2e       # E2E 테스트 실행
npm run test:cov       # 테스트 커버리지

# 데이터베이스
npm run seed                 # 관리자 사용자 생성
npm run migration:generate   # 엔티티에서 마이그레이션 생성
npm run migration:run        # 대기 중인 마이그레이션 실행
npm run migration:revert     # 마지막 마이그레이션 롤백
```

### 프론트엔드 (Web)

```bash
npm start              # 개발 서버
npm run build          # 프로덕션 빌드 → dist/
npm test               # 테스트 실행
npm run eject          # CRA에서 Eject (되돌릴 수 없음!)
```

---

## 코드 스타일

**백엔드**:
- TypeScript strict 모드 활성화
- ESLint 설정: `eslint.config.mjs`
- Prettier 설정: `.prettierrc`

**프론트엔드**:
- ESLint는 `react-app` 확장
- Prettier: `prettier@3.6.2`

---

## 테스트

### 백엔드 테스트

**테스트 구조**:
```
api/
├── src/
│   └── auth/
│       ├── auth.service.ts
│       ├── auth.service.spec.ts        # 유닛 테스트
│       └── auth.controller.spec.ts     # 컨트롤러 테스트
└── test/
    └── app.e2e-spec.ts                 # E2E 테스트
```

**테스트 예시** (`auth.service.spec.ts`):
- 올바른/틀린 자격 증명으로 로그인 테스트
- 토큰 생성 테스트
- 리프레시 토큰 플로우 테스트
- 모킹된 리포지토리 사용

**테스트 실행**:
```bash
# 유닛 테스트
npm run test

# E2E 테스트
npm run test:e2e

# 커버리지 리포트
npm run test:cov
```

### 프론트엔드 테스트

**테스팅 라이브러리**:
- `@testing-library/react`
- `@testing-library/jest-dom`
- `@testing-library/user-event`

**테스트 예시** (`App.test.js`):
```javascript
import { render, screen } from '@testing-library/react';
import App from './App';

test('renders learn react link', () => {
  render(<App />);
  const linkElement = screen.getByText(/learn react/i);
  expect(linkElement).toBeInTheDocument();
});
```

---

## 배포 체크리스트

> [!CAUTION]
> **모든 기본 비밀번호를 변경하지 않고 배포하지 마세요!**

상세한 체크리스트는 [DEPLOYMENT_CHECKLIST.md](../../../DEPLOYMENT_CHECKLIST.md)를 참조하세요.

### 중요한 배포 전 단계

#### 1. 보안

- [ ] 새 `JWT_SECRET` 생성:
  ```bash
  openssl rand -base64 64
  ```
- [ ] `envs/db_prod.env`의 모든 데이터베이스 비밀번호 변경
- [ ] `envs/elk.env`의 ELK 스택 비밀번호 변경
- [ ] `envs/db_prod.env`에 강력한 `ADMIN_PASSWORD` 설정
- [ ] `.gitignore`가 `*.env` 파일을 제외하는지 확인

#### 2. 설정

- [ ] `envs/api.env`에서 `NODE_ENV=production` 설정
- [ ] `reverse-proxy/default.conf`에서 Nginx 리버스 프록시 설정
- [ ] HTTPS용 SSL 인증서 설정
- [ ] `envs/api.env`에서 `FRONTEND_URL` 확인

#### 3. 빌드

- [ ] 프론트엔드 빌드:
  ```bash
  cd web
  npm run build
  # 출력: web/dist/
  ```
- [ ] 백엔드 빌드:
  ```bash
  cd api
  npm run build
  # 출력: api/dist/
  ```

#### 4. Docker 배포

> [!TIP]
> 프로덕션 배포에는 수동 명령어 대신 자동화된 CICDtools 스크립트를 사용하세요. [CI/CD & 운영 도구](#cicd--운영-도구) 참조.
> 가장 일반적인 명령어: `sudo ./CICDtools/update_all.sh`

```bash
# 설정 검증
docker-compose config

# 이미지 빌드
docker-compose build

# 모든 서비스 시작
docker-compose up -d

# 로그 보기
docker-compose logs -f

# 헬스 체크
curl http://localhost/api/health/live
```

#### 5. 데이터베이스 초기화

```bash
# 관리자 사용자로 데이터베이스 시딩
docker exec -it api npm run seed

# 또는 컨테이너 내에서 직접 실행
docker exec -it api node dist/seed.js
```

---

## CI/CD & 운영 도구

> [!IMPORTANT]
> 모든 배포 및 운영 작업은 수동 명령어가 아닌 이 자동화 스크립트를 사용해야 합니다. 전체 세부사항은 [CICDtools/README.md](../../../CICDtools/README.md)를 참조하세요.

### 배포 스크립트

| 스크립트 | 목적 | 다운타임 |
|--------|---------|----------|
| `update_frontend.sh` | 코드 풀, React 앱 빌드, dist 교체 (원자적) | **없음** |
| `update_backend.sh` | 코드 풀, API 컨테이너 재빌드 | ~1–5초 |
| `update_all.sh` | 프론트엔드 → DB 마이그레이션 → 백엔드 (순차) | ~1–5초 |
| `migrate_db.sh` | 안전성 검사 포함 TypeORM 마이그레이션 실행 | 없음 |

### 백업 & 복구

| 스크립트 | 목적 |
|----------|---------|
| `backup_db.sh` | DB 덤프 + uploads/logs 백업 → `backups/` |
| `restore_db.sh` | 최신 백업에서 복구 (데이터 덮어쓰기) |
| `inspect_backup.sh` | 백업 파일 내용 및 테이블 미리보기 |

### 모니터링 & 보안

| 스크립트 | 목적 |
|----------|---------|
| `check_health.sh` | 모든 Docker 컨테이너 상태 + API 헬스 확인 |
| `rotate_db_password.sh` | API 재시작과 함께 안전한 DB 비밀번호 교체 |

### 서버 설정 & 제거

| 스크립트 | 목적 |
|----------|---------|
| `ServerSetupRemove/set_env.sh` | 보안 환경 파일 생성 (시크릿 자동 생성) |
| `ServerSetupRemove/prodserver_quicksetup.sh` | 처음부터 프로덕션 서버 부트스트랩 |
| `ServerSetupRemove/devserver_quicksetup.sh` | 개발 서버 부트스트랩 |
| `ServerSetupRemove/server_quickremove.sh` | 모든 컨테이너, 데이터, 설정 파괴 |

### 운영 시나리오

| 시나리오 | 권장 스크립트 |
|----------|---------------|
| 일반적인 코드 업데이트 | `sudo ./CICDtools/update_all.sh` |
| 환경 변수 변경 | `envs/` 파일 수정 후 `sudo ./CICDtools/update_all.sh` |
| DB 비밀번호 교체 | `sudo ./CICDtools/rotate_db_password.sh` |
| 새 서버 설정 | `./CICDtools/ServerSetupRemove/prodserver_quicksetup.sh` |

> [!WARNING]
> 실행 중인 프로덕션 서버에서 `set_env.sh`를 실행하지 **마세요** — `JWT_SECRET`과 `DB_PASSWORD`를 재생성하여 모든 사용자가 로그아웃되고 DB 연결이 끊어집니다. 비밀번호 변경에는 `rotate_db_password.sh`를 사용하세요.

### 공유 유틸리티 (`utils/`)

- `common_logging.sh`: 색상 출력 및 파일 영속성이 있는 통합 로깅 (로그는 `CICDtools/logs/`에 저장)
- `git_utils.sh`: Git 사전 점검 — `git pull` 전에 로컬 변경사항 및 브랜치 충돌 감지

---

## 다음 단계

- **[6. 운영 및 문제 해결 →](./06_운영_및_문제해결.md)**: 일반적인 문제 해결 및 향후 계획
- **[← 4. 프론트엔드 아키텍처](./04_프론트엔드_아키텍처.md)**
- **[← 메인 문서로 돌아가기](./README.md)**
