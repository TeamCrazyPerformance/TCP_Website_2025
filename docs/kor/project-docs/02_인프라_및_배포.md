# 2. ì¸í”„ë¼ ë° ë°°í¬

> [â† ë©”ì¸ ë¬¸ì„œë¡œ ëŒì•„ê°€ê¸°](./README.md)

---

## Docker ì•„í‚¤í…ì²˜

ì• í”Œë¦¬ì¼€ì´ì…˜ì€ Docker Composeê°€ ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ì¡°ìœ¨í•˜ëŠ” **ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜**ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
graph TB
    User["User ğŸŒ"]
    CF["â˜ï¸ Cloudflare CDN/WAF<br/>(Orange Cloud Proxy)"]
    Internet[Origin Server]
    ReverseProxy["Reverse Proxy<br/>Nginx :80, :443"]
    Web["Web Server<br/>Nginx Static Files"]
    API["API Server<br/>NestJS :3000"]
    DB[("PostgreSQL<br/>Database :5432")]
    ES[("Elasticsearch<br/>:9200")]
    LS["Logstash<br/>:5000"]
    KB["Kibana<br/>:5601"]
    FB["Filebeat<br/>Container Logs"]

    User -->|"HTTPS"| CF
    CF -->|"HTTPS<br/>Origin Certificate"| Internet
    Internet --> ReverseProxy
    ReverseProxy --> Web
    ReverseProxy --> API
    API --> DB
    API --> LS
    LS --> ES
    FB --> ES
    KB --> ES

    style CF fill:#f6a821,stroke:#e8960f,color:#000
    style ReverseProxy fill:#e1f5ff
    style Web fill:#ffe1e1
    style API fill:#e1ffe1
    style DB fill:#ffffcc
    style ES fill:#ffe5cc
    style LS fill:#ffe5cc
    style KB fill:#ffe5cc
    style FB fill:#ffe5cc
```

---

## ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€

### Cloudflare í”„ë¡ì‹œ (Orange Cloud ğŸŸ )
- **ì—­í• **: CDN, DDoS ë°©ì–´, WAF, SSL ì¢…ë£Œ ë° ì¬ì•”í˜¸í™”
- **ë™ì‘ ë°©ì‹**:
  1. ì‚¬ìš©ì â†’ `teamcrazyperformance.com` DNS ì¡°íšŒ â†’ Cloudflare Edge IP ë°˜í™˜
  2. ì‚¬ìš©ì â†” Cloudflare: Cloudflareì˜ ê³µì¸ ì¸ì¦ì„œë¡œ HTTPS ì—°ê²°
  3. Cloudflare â†” Origin: Cloudflare Origin Certificateë¡œ HTTPS ì¬ì—°ê²°
- **ì¥ì **: ì›ë³¸ ì„œë²„ IP ì€ë‹‰, DDoS ë³´í˜¸, ì •ì  ìì› ìºì‹±, HTTP/2 ì§€ì›

### ë„¤íŠ¸ì›Œí¬ ê³„ì¸µ
- **ê³µìš© ë„¤íŠ¸ì›Œí¬**: ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë§Œ ì¸í„°ë„·ì— ë…¸ì¶œ (í¬íŠ¸ 80, 443)
- **ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬**: ë‹¤ë¥¸ ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ í†µì‹ 
  - ë°ì´í„°ë² ì´ìŠ¤: ì™¸ë¶€ ë…¸ì¶œ ì•ˆ ë¨ (ë³´ì•ˆ)
  - API: ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
  - ELK Stack: ë‚´ë¶€ ì „ìš© (SSH í„°ë„ë§ì„ í†µí•œ ì ‘ê·¼)

---

## ì£¼ìš” ì„œë¹„ìŠ¤

### 1. Reverse Proxy (Nginx)

**ëª©ì **: ëª¨ë“  HTTP/HTTPS ìš”ì²­ì˜ ì§„ì…ì 

**ë¼ìš°íŒ…**:
- `/api/*` â†’ API ì„œë²„
- `/*` â†’ ì •ì  ì›¹ íŒŒì¼

**ì„¤ì • íŒŒì¼**: `reverse-proxy/default.conf`

**ì£¼ìš” ê¸°ëŠ¥**:
- HTTP â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸ (í¬íŠ¸ 80 â†’ 443)
- HTTPS with Cloudflare Origin Certificate (TLSv1.2/1.3)
- ë„ë©”ì¸: `teamcrazyperformance.com`
- API ë¼ìš°íŒ…: `/api/*` â†’ NestJS ì„œë²„
- ì •ì  íŒŒì¼: `/*` â†’ React ë¹Œë“œ
- ì—…ë¡œë“œ íŒŒì¼ ì„œë¹™: `/activities/`, `/profiles/`, `/resources/`, `/teams/` â†’ API ì„œë²„

---

### 2. Web Server (Nginx)

**ëª©ì **: React í”„ë¡œë•ì…˜ ë¹Œë“œ ì„œë¹™

**ì„œë¹™ ë””ë ‰í† ë¦¬**: `./web/dist/`

**ì„¤ì • íŒŒì¼**: `./web/nginx.conf`

**íŠ¹ì§•**:
- SPA ë¼ìš°íŒ… ì§€ì› (ëª¨ë“  ê²½ë¡œ â†’ `index.html`)
- ì •ì  ìì‚° ìºì‹±
- Gzip ì••ì¶•

---

### 3. API Server (NestJS)

**ëª©ì **: ë°±ì—”ë“œ REST API

**í¬íŠ¸**: 3000 (ë‚´ë¶€)

**í™˜ê²½**: Production (`NODE_ENV=production`)

**ë³¼ë¥¨ ë§ˆìš´íŠ¸**:
- `./api/uploads` â†’ ì‚¬ìš©ì ì—…ë¡œë“œ íŒŒì¼
- `./api/json` â†’ ì •ì  JSON ë°ì´í„°
- `./logs/app` â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸

**ì£¼ìš” ê¸°ëŠ¥**:
- RESTful API ì—”ë“œí¬ì¸íŠ¸
- JWT ì¸ì¦
- íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
- ìŠ¤ì¼€ì¤„ ì‘ì—… ì‹¤í–‰

---

### 4. PostgreSQL Database

**ëª©ì **: ì£¼ ë°ì´í„° ì €ì¥ì†Œ

**ë²„ì „**: 16-alpine

**ì˜ì†ì„±**: 
- Docker ë³¼ë¥¨: `db-data`
- ë°±ì—… ë””ë ‰í† ë¦¬: `./db/backups/`

**ë³´ì•ˆ**:
- ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥
- SSH í„°ë„ì„ í†µí•œ ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥

---

### 5. ELK Stack (ë¡œê¹… & ëª¨ë‹ˆí„°ë§)

| ì„œë¹„ìŠ¤ | ëª©ì  | í¬íŠ¸ |
|---------|---------|------|
| **Elasticsearch** | ë¡œê·¸ ì €ì¥ & ê²€ìƒ‰ ì—”ì§„ | 9200 |
| **Logstash** | ë¡œê·¸ ì§‘ê³„ & ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ | 5000 |
| **Kibana** | ë¡œê·¸ ì‹œê°í™” ëŒ€ì‹œë³´ë“œ | 5601 |
| **Filebeat** | Docker ì»¨í…Œì´ë„ˆ ë¡œê·¸ ìˆ˜ì§‘ | - |

**ë¡œê·¸ íë¦„**:
```
API ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ Winston â†’ Logstash â†’ Elasticsearch â† Filebeat (Docker ë¡œê·¸)
                                                â†“
                                             Kibana (ì‹œê°í™”)
```

---

## í¬íŠ¸ ìš”ì•½

| ì„œë¹„ìŠ¤ | ë‚´ë¶€ í¬íŠ¸ | ì™¸ë¶€ í¬íŠ¸ | ì ‘ê·¼ |
|---------|-----------|-----------|------|
| Reverse Proxy | 80, 443 | 80, 443 | ê³µê°œ |
| Web | 80 | - | ë‚´ë¶€ ì „ìš© |
| API | 3000 | - | ë‚´ë¶€ ì „ìš© |
| PostgreSQL | 5432 | - | ë‚´ë¶€ ì „ìš© |
| Elasticsearch | 9200 | - | ë‚´ë¶€ ì „ìš© (SSH í„°ë„) |
| Kibana | 5601 | - | ë‚´ë¶€ ì „ìš© (SSH í„°ë„) |
| Logstash | 5000 | - | ë‚´ë¶€ ì „ìš© |

---

## SSH í„°ë„ë§ (ë‚´ë¶€ ì„œë¹„ìŠ¤ ì ‘ê·¼)

Kibanaë‚˜ PostgreSQLì„ ë¡œì»¬ ë¨¸ì‹ ì—ì„œ ì ‘ê·¼í•˜ë ¤ë©´:

```bash
# Kibana ì ‘ê·¼
ssh -L 5601:localhost:5601 user@your-server
# ê·¸ ë‹¤ìŒ ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5601 ì ‘ì†

# PostgreSQL ì ‘ê·¼
ssh -L 5432:localhost:5432 user@your-server
# ê·¸ ë‹¤ìŒ DB í´ë¼ì´ì–¸íŠ¸ë¡œ localhost:5432 ì—°ê²°
```

---

## Docker Compose ì„œë¹„ìŠ¤ êµ¬ì„±

### í”„ë¡œë•ì…˜ í™˜ê²½ (`docker-compose.yml`)

```yaml
services:
  reverse-proxy:    # Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ
  web:              # React í”„ë¡œë•ì…˜ ë¹Œë“œ
  api:              # NestJS ë°±ì—”ë“œ
  db:               # PostgreSQL
  elasticsearch:    # ë¡œê·¸ ì €ì¥
  logstash:         # ë¡œê·¸ ì²˜ë¦¬
  kibana:           # ë¡œê·¸ ì‹œê°í™”
  filebeat:         # ë¡œê·¸ ìˆ˜ì§‘
```

### ê°œë°œ í™˜ê²½ (`docker-compose.dev.yml`)

```yaml
services:
  db:               # PostgreSQLë§Œ Dockerë¡œ ì‹¤í–‰
                    # APIì™€ WebëŠ” ë¡œì»¬ì—ì„œ ì§ì ‘ ì‹¤í–‰
```

---

## ë‹¤ìŒ ë‹¨ê³„

- **[3. ë°±ì—”ë“œ ì•„í‚¤í…ì²˜ â†’](./03_ë°±ì—”ë“œ_ì•„í‚¤í…ì²˜.md)**: NestJS ëª¨ë“ˆ êµ¬ì¡°ì™€ í•µì‹¬ ì‹œìŠ¤í…œ ì´í•´í•˜ê¸°
- **[â† 1. í”„ë¡œì íŠ¸ ê°œìš”](./01_í”„ë¡œì íŠ¸_ê°œìš”_ë°_ê¸°ìˆ ìŠ¤íƒ.md)**
- **[â† ë©”ì¸ ë¬¸ì„œë¡œ ëŒì•„ê°€ê¸°](./README.md)**
