version: "3.8"

services:
  # ----------------------------
  # Reverse Proxy (외부 공개)
  # ----------------------------
  reverse-proxy:
    image: nginx:1.25-alpine
    container_name: reverse-proxy
    depends_on:
      - api
      - web
    ports:
      - "80:80"        # 필요 시 443도 추가하고 TLS 설정 권장
    volumes:
      - ./reverse-proxy/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [public, internal]
    restart: unless-stopped

  # ----------------------------
  # Static Web (정적 자산 서빙)
  # ----------------------------
  web:
    image: nginx:1.25-alpine
    container_name: web
    # 프런트엔드 빌드 산출물(예: React/Vite의 dist)을 아래 경로에 두세요.
    volumes:
      - ./web/dist:/usr/share/nginx/html:ro
      # 필요 시 커스텀 캐시/압축 설정:
      - ./web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # API (NestJS)
  # ----------------------------
  api:
    build: ./api
    container_name: api
    # 프로덕션에서 직접 공개하지 않고 reverse-proxy 통해 접근하도록 expose 사용
    expose:
      - "3000"
    environment:
      # DB
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=mydb
      # Auth
      - JWT_SECRET=my_jwt_secret
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Logstash(윈스턴 TCP/UDP 전송 시 사용)
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    volumes:
      - ./api/public/activities:/var/app/public/activities
    depends_on:
      db:
        condition: service_healthy
      logstash:
        condition: service_started
    command: node dist/main.js
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # PostgreSQL
  # ----------------------------
  db:
    image: postgres:16-alpine
    container_name: db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mydb
    # 개발 편의 목적: 로컬 DB 도구로 붙고 싶으면 유지, 보안상 필요 없으면 제거
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d mydb || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Redis (세션/캐시/레이트리밋)
  # ----------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    # 개발 편의로 열어둠. 필요 없으면 ports 제거하고 내부망만 사용하세요.
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Logstash (로그 수집)
  # ----------------------------
  logstash:
    image: docker.elastic.co/logstash/logstash:8.9.0
    container_name: logstash
    # TCP 입력 5000 (Winston TCP/UDP 전송 포트 예시)
    ports:
      - "5000:5000"
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline:ro
    depends_on:
      - elasticsearch
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Elasticsearch (단일 노드)
  # ----------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.9.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      # 개발 편의: 보안 비활성 (프로덕션에서는 활성화를 권장)
      - xpack.security.enabled=false
    # 개발 편의상 직접 접근 포트 개방 (원치 않으면 제거)
    ports:
      - "9200:9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Kibana
  # ----------------------------
  kibana:
    image: docker.elastic.co/kibana/kibana:8.9.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    # 개발 편의상 직접 접근 포트 개방 (원치 않으면 제거)
    ports:
      - "5601:5601"
    networks: [internal]
    restart: unless-stopped

# ----------------------------
# 네트워크
# ----------------------------
networks:
  public:   { driver: bridge }
  internal: { driver: bridge }

# ----------------------------
# 볼륨
# ----------------------------
volumes:
  db-data:
  es-data:
  redis-data:
