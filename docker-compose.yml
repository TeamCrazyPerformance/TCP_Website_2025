services:
  # ----------------------------
  # Reverse Proxy (외부 공개)
  # ----------------------------
  reverse-proxy:
    image: nginx:1.25-alpine
    container_name: reverse-proxy
    depends_on:
      - api
      - web
    ports:
      - "80:80"        # 필요 시 443도 추가하고 TLS 설정 권장
    volumes:
      - ./reverse-proxy/default.conf:/etc/nginx/conf.d/default.conf:ro
    networks: [public, internal]
    restart: unless-stopped

  # ----------------------------
  # Static Web (정적 자산 서빙)
  # ----------------------------
  web:
    image: nginx:1.25-alpine
    container_name: web
    # 프런트엔드 빌드 산출물(예: React/Vite의 dist)을 아래 경로에 두세요.
    volumes:
      - ./web/dist:/usr/share/nginx/html:ro
      # 필요 시 커스텀 캐시/압축 설정:
      - ./web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    expose:
      - "80"
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # API (NestJS)
  # ----------------------------
  api:
    build: ./api
    container_name: api
    # 프로덕션에서 직접 공개하지 않고 reverse-proxy 통해 접근하도록 expose 사용
    expose:
      - "3000"
    environment:
      # DB
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=user
      - DB_PASSWORD=password
      - DB_NAME=mydb
      # Auth
      - JWT_SECRET=my_jwt_secret
      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Logstash(윈스턴 TCP/UDP 전송 시 사용)
      - LOGSTASH_HOST=logstash
      - LOGSTASH_PORT=5000
    volumes:
      - ./api/uploads:/var/app/uploads
      - ./logs/app:/var/app/logs
    depends_on:
      db:
        condition: service_healthy
      logstash:
        condition: service_started
    command: node dist/main.js
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # PostgreSQL
  # ----------------------------
  db:
    image: postgres:16-alpine
    container_name: db
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mydb
    # 내부 네트워크에서만 접근 가능 (보안)
    expose:
      - "5432"
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./db/backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d mydb || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Redis (세션/캐시/레이트리밋)
  # ----------------------------
  redis:
    image: redis:7-alpine
    container_name: redis
    # 내부 네트워크에서만 접근 가능 (보안)
    expose:
      - "6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-data:/data
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Logstash (로그 수집)
  # ----------------------------
  logstash:
    image: docker.elastic.co/logstash/logstash:8.9.0
    container_name: logstash
    env_file:
      - ./envs/elk.env
    # 내부 네트워크에서만 접근 가능 (보안)
    expose:
      - "5000"
    volumes:
      - ./elk/logstash:/usr/share/logstash/pipeline:ro
    depends_on:
      - elasticsearch
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Elasticsearch (단일 노드)
  # ----------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.9.0
    container_name: elasticsearch
    env_file:
      - ./envs/elk.env
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      # X-Pack 보안 활성화 (프로덕션)
      - xpack.security.enabled=true
    # 내부 네트워크에서만 접근 가능 (보안)
    expose:
      - "9200"
    volumes:
      - es-data:/usr/share/elasticsearch/data
      - ./elk/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Kibana
  # ----------------------------
  kibana:
    image: docker.elastic.co/kibana/kibana:8.9.0
    container_name: kibana
    env_file:
      - ./envs/elk.env
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    depends_on:
      - elasticsearch
    volumes:
      - ./elk/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
    # 내부 네트워크에서만 접근 가능 (보안)
    expose:
      - "5601"
    networks: [internal]
    restart: unless-stopped

  # ----------------------------
  # Filebeat (Docker 로그 수집)
  # ----------------------------
  filebeat:
    image: docker.elastic.co/beats/filebeat:8.9.0
    container_name: filebeat
    user: root  # Docker 소켓 접근을 위해 root 필요
    env_file:
      - ./envs/elk.env
    volumes:
      - ./elk/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - elasticsearch
    networks: [internal]
    restart: unless-stopped

# ----------------------------
# 네트워크
# ----------------------------
networks:
  public:   { driver: bridge }
  internal: { driver: bridge }

# ----------------------------
# 볼륨
# ----------------------------
volumes:
  db-data:
  es-data:
  redis-data:
