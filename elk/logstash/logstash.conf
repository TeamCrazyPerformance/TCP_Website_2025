# =============================================================================
# Logstash Pipeline Configuration for NestJS Application
# =============================================================================

input {
  # TCP input for receiving logs from NestJS (Winston TCP transport)
  tcp {
    port => 5000
    codec => json_lines
    tags => ["nestjs", "tcp"]
  }

  # UDP input as an alternative (optional, for high-throughput scenarios)
  udp {
    port => 5000
    codec => json_lines
    tags => ["nestjs", "udp"]
  }
}

filter {
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
      remove_field => ["timestamp"]
    }
  }

  # Add application metadata
  mutate {
    add_field => {
      "application" => "tcp-website-api"
      "environment" => "${NODE_ENV:development}"
    }
  }

  # Parse log level to lowercase for consistency
  if [level] {
    mutate {
      lowercase => ["level"]
    }
  }

  # Extract error details if present
  if [error] {
    mutate {
      rename => {
        "[error][message]" => "error_message"
        "[error][stack]" => "error_stack"
      }
    }
  }

  # Add severity number for easier filtering in Kibana
  if [level] == "error" {
    mutate { add_field => { "severity" => 3 } }
  } else if [level] == "warn" {
    mutate { add_field => { "severity" => 4 } }
  } else if [level] == "log" or [level] == "info" {
    mutate { add_field => { "severity" => 6 } }
  } else if [level] == "debug" {
    mutate { add_field => { "severity" => 7 } }
  } else if [level] == "verbose" {
    mutate { add_field => { "severity" => 8 } }
  }

  # Convert severity to integer
  mutate {
    convert => { "severity" => "integer" }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    user => "elastic"
    password => "${ELASTIC_PASSWORD}"
    index => "nestjs-logs-%{+YYYY.MM.dd}"
    # Template for index mapping (optional, Elasticsearch will auto-create)
    template_name => "nestjs-logs"
    template_overwrite => true
  }

  # Also output to stdout for debugging (remove in production)
  stdout {
    codec => rubydebug
  }
}
